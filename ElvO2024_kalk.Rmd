---
title: "ElvO24_kalk"
output: pdf_document
date: "2025-06-16"
editor_options: 
  chunk_output_type: console
---

PÃ¥ samme mÃ¥te som i 2020 sÃ¥ skal vi ogsÃ¥ i Ã¥r ha med resultater fra noen av de kalkede elvene. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, results=FALSE, message=FALSE, warning=FALSE}
#install.packages(c("dplyr", "ggplot2", "plyr", "Rmisc", "tidyverse", "lubridate", "stringr"))
Packages <- c("plyr", "dplyr", "ggplot2",  "Rmisc", "tidyverse", "lubridate", "stringr", "tm")
lapply(Packages, library, character.only = TRUE)
```

```{r echo = T, results = 'hide'}
#to set number of decimal in figures
fmt_dcimals <- function(decimals=1){
  function(x) format(x,nsmall = decimals,scientific = FALSE)
}
```

```{r echo = T, results = 'hide'}
dLimity <- function(v){
  v <- as.character(v)
  isLimit <- grepl("<", v)  #grepl() is a built-in R function looks for a smaller string of characters
  v[isLimit] <- as.numeric(gsub("<(.*)", "\\1", v[isLimit]))/2 #gsub(pattern, replacement, x) for #substitution
  as.numeric(v)
}
```

```{r echo = T, results = 'hide'}
Sys.setlocale(locale="no_NO") 

kalk <- read.table("Kalkelver_data til ElvO_2019-2024.txt", header=TRUE, sep="\t", na.string=c(""))

#ikke fÃ¸lgende elver: Uskedalselva og Yndesdalselva 
print(unique(kalk$Lokalitet))
print(unique(kalk$Vassdrag))

```

FÃ¸lgende parametere skal plottes, 2025 og 2019-2023 gjennomsnitt:
- pH
- Ca
- Turb
- SiO2
- TOC
- POC + DOC (2024)
- TotP
- TotN
- NH4, NO3, Org N (2024)
- Metaller
- Uv abs - hvis bra nok data

```{r}
kalk$Dato <- as.Date(kalk$Dato,format = "%d.%m.%Y")
kalk$year <- year(kalk$Dato) 
kalk$month <- month(kalk$Dato) 
```

From wide to long
```{r}
#from wide to long format
kalk_long <- gather(kalk, parameter, verdi, pH:abs_410.nm, factor_key=TRUE)

kalk_24 <- subset(kalk_long, year==2024)
kalk_ave <- subset(kalk_long, !year==2024)
#nrow(kalk_ave)
```
Gjennomsnitt av gjennomsnittet, ta fÃ¸rst gjennomsnitt per Ã¥r og sÃ¥ alle Ã¥rene sammen

```{r Make averages}
#MAKE summary tables of parameters, remember to expand the variable selection!
#First, summary per year
fo <- kalk_ave %>%
  group_by(Vassdrag, year, parameter) %>%
  select(verdi) %>% # select variables to summarise, from and to
  summarise(across(everything(), .f = list(mean = mean), na.rm = TRUE))

#then, summary together, 5-year with sd

fox<- fo %>%
  group_by(Vassdrag, parameter) %>%
  select(verdi_mean)%>%
  summarise(across(everything(), .f = list(mean = mean, sd=sd), na.rm = TRUE))

#foxy <- foxy[-(3)]
names(fox) <- c("Vassdrag", "parameter", "verdi_mean", "xsd")
fox$year <- "5-year mean"
foxy = fox %>% relocate(year, .after = "Vassdrag")
```

```{r}
#Dato er hovedsaklig hvis det er flere prÃ¸ver per dato. Kanksje bÃ¸r den byttes om til mÃ¥ned for disse prÃ¸vene?
aa24 <- kalk_24 %>%
  group_by(Vassdrag, Dato, parameter) %>%
  select(verdi) %>% # select variables to summarise, from and to
  summarise(across(everything(), .f = list(mean = mean), na.rm = TRUE))

aa24x <- aa24 %>%
  group_by(Vassdrag, parameter) %>%
  select(verdi_mean) %>% # select variables to summarise, from and to
  summarise(across(everything(), .f = list(mean = mean, sd=sd), na.rm = TRUE))

names(aa24x) <- c("Vassdrag", "parameter", "verdi_mean", "xsd")
aa24x$year <- "2024 mean"
df.sum24 = aa24x %>% relocate(year, .after = "Vassdrag")
```

Add the two together and make new summary table. select only those parameters to be used for the automatic plotting
```{r}
# 6) Merge the two datasets
All <- rbind(df.sum24, foxy)
#only those parameters with regular bargraphs, nothing special
#print(unique(All$chem))
print(unique(All$Vassdrag))
print(unique(All$parameter))

dfsum2x <- All  %>% 
  filter(parameter %in% c("Ca", "Turbiditet", "SiO2", "TOC", "TotN", "TotP", "As", "Pb", "Cd", "Cu", "Zn", "Cr", "pH", "Ni"))

dfsum2xxx = dfsum2x  %>% filter(str_detect(parameter,"Ca|Turbiditet|SiO2|TOC|TotN|TotP|As|Pb|Cd|Cu|Zn|Cr|pH|Ni"))

unique(All$chem)
#print(unique(dfsum2$Station.name))

write.csv(All, "250612_test.csv")
#write.csv(dfsum2y, "240701_test2.csv")
```


REMAINS TO BE DONE!
Set order of station names and legend titles
- make sure that the norwegian letters are in the names
```{r}
#remove two rivers
dfsum5 <- subset(dfsum2xxx, !Vassdrag %in% c("Uskedalselva", "Yndelsdalselva", "Tovdalselva"))


#fix misspelled names
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("Arendalsvassdraget"="Nidelva"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("Suldalsl???gen"="Suldalslågen"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("SuldalslÃ¥gen"="Suldalslågen"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("R?dneelva"="Rødneelva"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("RÃ¸dneelva"="Rødneelva"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("J?rpelandselva"="Jørpelandselva"))
dfsum5$Vassdrag <- revalue(dfsum5$Vassdrag, c("JÃ¸rpelandselva"="Jørpelandselva"))

print(unique(dfsum5$Vassdrag))

dfsum6 <- dfsum5 %>% 
  mutate(Vassdrag = factor(Vassdrag, # put education levels in logical order
                               levels = c("Audna", "Mandalselva", "Lygna", "Kvina", "Tovdalselva", "Nidelva",
                                          "Ogna", "Sokndalselva", "Frafjordelva", "Espedalselva", "Lyseelva", "Jørpelandselva", "Ekso", "Modalselva", "Guddalsvassdraget", "Rødneelva", "Suldalslågen")))

#title, abbr
dfsum7 <- dfsum5 %>% 
  group_by(parameter, year) %>% 
           mutate(year=factor(year,
                     levels=c("5-year mean", "2024 mean")))
```
Use the following for making automatised figures with correct axis-titles. BUT make sure to only include those variables you will plot. 
```{r}
#try TO MAKE NICER TITLES
dfsum3 <- dfsum7 %>%
  mutate(title = case_when(
    parameter== "Turbiditet" ~ "Turbidity",
    parameter== "TOC" ~ "Total organic carbon",
    parameter== "TOTN" ~ "Total nitrogen",
    parameter== "TOTP" ~ "Total phosphorous",
    parameter== "SiO2" ~ "Silica",
    parameter== "As" ~ "Arsenic",
    parameter== "Pb" ~ "Lead",
    parameter== "Cd" ~ "Cadmium",
    parameter== "Cu" ~ "Copper",
    parameter== "Zn" ~ "Zinc",
    parameter== "Cr" ~ "Chromium",
    parameter== "Ca" ~ "Calcium",
    parameter== "pH" ~ "pH",
    parameter== "Ni" ~ "Nickel",
    )) %>%
  mutate(abbr = case_when(
    parameter== "Turbiditet" ~ "TURB (FNU)",
    parameter== "TOC" ~ "TOC (mg/L)",
    parameter== "TOTN" ~ "Tot-N (Âµg/L)",
    parameter== "TOTP" ~ "Tot-P (Âµg/L)",
    parameter== "SiO2" ~ "SiO2 (mg/L)",
    parameter== "As" ~ "As (Âµg/L)",
    parameter== "Pb" ~ "Pb (Âµg/L)",
    parameter== "Cd" ~ "Cd (Âµg/L)",
    parameter== "Cu" ~ "Cu (Âµg/L)",
    parameter== "Zn" ~ "Zn (Âµg/L)",
    parameter== "Cr" ~ "Cr (Âµg/L)",
    parameter== "Ca" ~ "Ca (mg/L)",
    parameter== "pH" ~ "pH unit",
    parameter== "Ni" ~ "Ni (Âµg/L)",
  ))
```


Automatised plots for variables not requiering individual adaptations such as e.g. facets
The plots shall be stored as png files in designated folder.
```{r}
plot.dfsum3 <- function(v=dfsum3){ 
  chems = unique(dfsum3$parameter)
  abbrs = unique(dfsum3$abbr)
  titles = unique(dfsum3$title)
}

chems = unique(dfsum3$parameter)
abbrs = unique(dfsum3$abbr)
titles = unique(dfsum3$title)

# a vector of names or regions to loop over 
for (i in seq_along(chems)){

  #a loop to produce gglopt2 graphs
  ploy <- dfsum3 %>%
    ggplot(aes(x = Vassdrag, fill = as.factor(year))) +
    geom_col(data = filter(dfsum3, parameter == chems[i]),
             width=0.8, position=position_dodge(),
             aes(y = verdi_mean))+
    geom_errorbar(data = filter(dfsum3, parameter == chems[i]),
                  aes(x=Vassdrag, ymin=pmax(verdi_mean-xsd, 0), ymax=verdi_mean+xsd), #pmax+++ added to not show negative sd
                  width=.4,linewidth=0.4, position=position_dodge(width=0.8), col="black")+
    scale_fill_manual(name="year", 
                      values=c("5-year mean" = "sienna2",
                               "2024 mean" = "cyan4"))+
    theme_light()+
    theme(axis.text.y = element_text(size= 16, colour="black"),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size=20, margin=margin(0,20,0,0)),
          axis.text.x = element_text(size = 16, angle=45, hjust=1,  colour="black"),
          legend.title = element_blank(),
          legend.text=element_text(size=16),
          legend.spacing.x = unit(0.2, 'cm'),
          plot.title = element_text(size = 24, hjust = 0.5),
          panel.grid.major.x = element_blank(),
          strip.background = element_blank(),
          strip.text.x = element_blank())+
    theme(legend.position="top")+
    labs(title = titles[i], y=abbrs[i])+
    scale_y_continuous(labels = fmt_dcimals(0))
  
#print(ploy)

if (dir.exists("output_kalk")) {  
} else {dir.create("output_kalk")
  }

ggsave(filename = paste0("output_kalk/",
                         chems[i],
                         "_plot.png"),
       plot = ploy,
       width = 11, height = 8.5, units = "in")

}

```

Sokndalselva Ca antatt feil unit så delte verdiene på 1000: Datoer 07.09.2020 og 14.09.2020


Plotting - may need some adaptation

```{r}
#
#dfsum3x <- subset(dfsum3, !Vassdrag %in% c("Tovdalselva"))

pH22 <- ggplot(subset(dfsum3, parameter %in% c("pH")) , aes(x=Vassdrag, y=verdi_mean, fill=year))  +
  geom_col( width=0.8, position=position_dodge())+
  geom_errorbar(aes(x=Vassdrag, ymin=pmax(verdi_mean-xsd, 0), ymax=verdi_mean+xsd),
                width=.4,size=0.4, position=position_dodge(width=0.8), col="black")+
  theme_light()+
  scale_fill_manual(values = c("sienna2", "cyan4"))+
  theme(axis.text.y = element_text(size= 16, colour="black"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=20, margin=margin(0,20,0,0)),
        axis.text.x = element_text(size = 16, angle=45, hjust=1,  colour="black"),
        legend.title = element_blank(),
        legend.text=element_text(size=16),
        legend.spacing.x = unit(0.2, 'cm'),
        plot.title = element_text(size = 24, hjust = 0.5),
        panel.grid.major.x = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank())+
  theme(legend.position="top")+
  labs(title = "pH", x = "", y = "pH units")+
  coord_cartesian(ylim = c(5, 8.5))+
  scale_y_continuous(breaks=c(5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5), labels = fmt_dcimals(1))

ggsave(filename = "output_kalk/pH24_scale.png",
       plot = pH22,
       width = 11, height = 8.5, units = "in")
```


Need to make new plots for those parameters with only a few of the rivers. Is it the same rivers for all parameters?
- metaller: Ekso, Lygna, Nidelva, Suldalslågen
